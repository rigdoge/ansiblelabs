---
# 安装基础依赖
- name: Install basic dependencies
  apt:
    name:
      - curl
      - gnupg
      - apt-transport-https
    state: present

# 添加 Team RabbitMQ 的密钥
- name: Add Team RabbitMQ main signing key
  get_url:
    url: https://keys.openpgp.org/vks/v1/by-fingerprint/0A9AF2115F4687BD29803A206B73A36E6026DFCA
    dest: /usr/share/keyrings/com.rabbitmq.team.gpg
    mode: '0644'

# 添加 RabbitMQ Erlang 仓库密钥
- name: Add RabbitMQ Erlang repository key
  get_url:
    url: https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-erlang.E495BB49CC4BBE5B.key
    dest: /usr/share/keyrings/rabbitmq.E495BB49CC4BBE5B.gpg
    mode: '0644'

# 添加 RabbitMQ Server 仓库密钥
- name: Add RabbitMQ Server repository key
  get_url:
    url: https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-server.9F4587F226208342.key
    dest: /usr/share/keyrings/rabbitmq.9F4587F226208342.gpg
    mode: '0644'

# 配置 RabbitMQ 仓库
- name: Configure RabbitMQ repositories
  template:
    src: rabbitmq.list.j2
    dest: /etc/apt/sources.list.d/rabbitmq.list
    mode: '0644'

# 更新包索引
- name: Update package indices
  apt:
    update_cache: yes

# 安装 Erlang 包
- name: Install Erlang packages
  apt:
    name:
      - erlang-base=1:26.2.5.6-1
      - erlang-asn1=1:26.2.5.6-1
      - erlang-crypto=1:26.2.5.6-1
      - erlang-eldap=1:26.2.5.6-1
      - erlang-ftp=1:26.2.5.6-1
      - erlang-inets=1:26.2.5.6-1
      - erlang-mnesia=1:26.2.5.6-1
      - erlang-os-mon=1:26.2.5.6-1
      - erlang-parsetools=1:26.2.5.6-1
      - erlang-public-key=1:26.2.5.6-1
      - erlang-runtime-tools=1:26.2.5.6-1
      - erlang-snmp=1:26.2.5.6-1
      - erlang-ssl=1:26.2.5.6-1
      - erlang-syntax-tools=1:26.2.5.6-1
      - erlang-tftp=1:26.2.5.6-1
      - erlang-tools=1:26.2.5.6-1
      - erlang-xmerl=1:26.2.5.6-1
    state: present

# 安装 RabbitMQ
- name: Install RabbitMQ server
  apt:
    name: rabbitmq-server
    state: present
    update_cache: yes
    fix_missing: yes

# 配置 RabbitMQ
- name: Create RabbitMQ configuration directory
  file:
    path: /etc/rabbitmq
    state: directory
    mode: '0755'

- name: Configure RabbitMQ
  template:
    src: rabbitmq.conf.j2
    dest: /etc/rabbitmq/rabbitmq.conf
    mode: '0644'
  notify: restart rabbitmq

- name: Configure RabbitMQ environment
  template:
    src: rabbitmq-env.conf.j2
    dest: /etc/rabbitmq/rabbitmq-env.conf
    mode: '0644'
  notify: restart rabbitmq

# 启用管理插件
- name: Enable RabbitMQ management plugin
  rabbitmq_plugin:
    names: rabbitmq_management
    state: enabled
  notify: restart rabbitmq

# 创建管理员用户
- name: Create admin user
  rabbitmq_user:
    user: "{{ rabbitmq_admin_user }}"
    password: "{{ rabbitmq_admin_password }}"
    tags: administrator
    vhost: /
    configure_priv: .*
    read_priv: .*
    write_priv: .*
    state: present

# 删除默认 guest 用户
- name: Remove default guest user
  rabbitmq_user:
    user: guest
    state: absent

# 安装 RabbitMQ Exporter
- name: Download RabbitMQ Exporter
  get_url:
    url: "https://github.com/rabbitmq/rabbitmq-server/releases/download/v{{ rabbitmq_version }}/rabbitmq-server_{{ rabbitmq_version }}-1_all.deb"
    dest: /tmp/rabbitmq-exporter.deb
    mode: '0644'

- name: Install RabbitMQ Exporter
  apt:
    deb: /tmp/rabbitmq-exporter.deb
    state: present

# 配置 RabbitMQ Exporter 服务
- name: Configure RabbitMQ Exporter service
  template:
    src: rabbitmq-exporter.service.j2
    dest: /etc/systemd/system/rabbitmq-exporter.service
    mode: '0644'
  notify: restart rabbitmq-exporter

# 启动并启用服务
- name: Start and enable RabbitMQ service
  systemd:
    name: rabbitmq-server
    state: started
    enabled: yes
    daemon_reload: yes

- name: Start and enable RabbitMQ Exporter service
  systemd:
    name: rabbitmq-exporter
    state: started
    enabled: yes
    daemon_reload: yes

# 配置 Prometheus 告警规则
- name: Configure RabbitMQ Prometheus alert rules
  template:
    src: rabbitmq.rules.yml.j2
    dest: /etc/prometheus/rabbitmq.rules.yml
    mode: '0644'
  notify: reload prometheus 